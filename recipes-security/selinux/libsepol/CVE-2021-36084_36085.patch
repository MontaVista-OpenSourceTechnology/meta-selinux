From de0f92e2670f6d1e2e4a87e8a2d7bcaf1c88477d Mon Sep 17 00:00:00 2001
From: Milan Shah <mshah@mvista.com>
Date: Mon, 8 Nov 2021 14:24:27 +0530
Subject: [PATCH] libsepol/cil: Destroy classperm list when resetting map perms

Map perms share the same struct as regular perms, but only the
map perms use the classperms field. This field is a pointer to a
list of classperms that is created and added to when resolving
classmapping rules, so the map permission doesn't own any of the
data in the list and this list should be destroyed when the AST is
reset.

When resetting a perm, destroy the classperms list without destroying
the data in the list.

Signed-off-by: James Carter <jwcart2@gmail.com>

Upstream-Status: Backport
CVE: CVE-2021-{36084|36085}
Signed-off-by: Milan Shah <mshah@mvista.com>
---
 cil/src/cil_reset_ast.c | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/cil/src/cil_reset_ast.c b/cil/src/cil_reset_ast.c
index 8a13a1c..20bc3b9 100644
--- a/cil/src/cil_reset_ast.c
+++ b/cil/src/cil_reset_ast.c
@@ -52,7 +52,7 @@ static void cil_reset_classpermission(struct cil_classpermission *cp)
 		return;
 	}
 
-	cil_reset_classperms_list(cp->classperms);
+	cil_list_destroy(&cp->classperms, CIL_FALSE);
 }
 
 static void cil_reset_classperms_set(struct cil_classperms_set *cp_set)
-- 
2.7.4

